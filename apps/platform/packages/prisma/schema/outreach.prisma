// =============================================================================
// OUTREACH SYSTEM SCHEMA
// Cold Email Automation for B2B Prospecting
// =============================================================================

// -----------------------------------------------------------------------------
// WORKSPACE EMAIL ACCOUNTS
// Connected email accounts for sending outreach (Gmail/Outlook OAuth)
// -----------------------------------------------------------------------------

enum EmailProvider {
  gmail
  outlook
  resend
}

model WorkspaceEmailAccount {
  id          String        @id @default(cuid())
  workspaceId String
  provider    EmailProvider
  email       String
  displayName String? // "John from Acme Inc"

  // OAuth Tokens (encrypted at rest)
  accessToken    String    @db.Text
  refreshToken   String?   @db.Text
  tokenExpiresAt DateTime?

  // Gmail-specific
  gmailHistoryId String? // For push notification sync

  // Settings
  isDefault Boolean @default(false)
  isActive  Boolean @default(true)

  // Tracking
  lastUsedAt DateTime?
  totalSent  Int       @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  workspace Project @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@unique([workspaceId, email])
  @@index(workspaceId)
  @@index([workspaceId, isDefault])
}

// -----------------------------------------------------------------------------
// OUTREACH JOB QUEUE
// Track async jobs for reliability and DLQ
// -----------------------------------------------------------------------------

enum OutreachJobStatus {
  pending
  processing
  completed
  failed
  dead_letter
}

enum OutreachJobType {
  send_email
  process_followups
  sync_inbox
}

model OutreachJob {
  id          String            @id @default(cuid())
  workspaceId String
  type        OutreachJobType
  status      OutreachJobStatus @default(pending)

  // Job data
  payload Json  @db.Json
  result  Json? @db.Json

  // Retry tracking
  attempts    Int     @default(0)
  maxAttempts Int     @default(3)
  lastError   String? @db.Text

  // Scheduling
  scheduledFor DateTime  @default(now())
  startedAt    DateTime?
  completedAt  DateTime?

  // QStash tracking
  qstashMessageId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index(workspaceId)
  @@index([status, scheduledFor])
  @@index(qstashMessageId)
}

// -----------------------------------------------------------------------------
// ENUMS
// -----------------------------------------------------------------------------

enum OutreachCampaignStatus {
  draft
  active
  paused
  completed
  cancelled
}

enum OutreachCampaignType {
  cold_email           // Standard cold email campaign
  follow_up            // Follow-up sequences
  nurture              // Long-term nurture sequences
}

enum ApprovalMode {
  manual // All emails require human approval
  auto   // AI handles everything
  hybrid // Auto for some, manual for others
}

enum ConversationStatus {
  pending_outreach // Not yet contacted
  outreach_sent    // Initial email sent
  follow_up_1      // First follow-up sent
  follow_up_2      // Second follow-up sent
  follow_up_final  // Final follow-up sent
  awaiting_response // Waiting for prospect reply
  replied          // Prospect replied (positive or negative)
  meeting_booked   // Meeting booked (success!)
  not_interested   // Prospect not interested
  no_response      // No response after all follow-ups
  bounced          // Email bounced
  closed           // Conversation closed
}

enum MessageSender {
  user     // Our side (AI or human)
  prospect // The prospect's reply
  system   // System notifications
}

enum MessageGeneratedBy {
  ai       // Generated by AI
  human    // Written by human
  template // From predefined template
}

enum EmailTemplateType {
  initial_outreach
  follow_up_1
  follow_up_2
  follow_up_final
  meeting_request
  value_add
  case_study
  custom
}

// -----------------------------------------------------------------------------
// OUTREACH CAMPAIGN
// Cold email campaign targeting B2B prospects
// -----------------------------------------------------------------------------

model OutreachCampaign {
  id          String  @id @default(cuid())
  workspaceId String
  userId      String // Campaign owner

  // Campaign Info
  name        String
  description String?                @db.Text
  type        OutreachCampaignType   @default(cold_email)
  status      OutreachCampaignStatus @default(draft)

  // Sender Info (for personalization)
  senderName     String
  senderTitle    String?
  senderCompany  String?
  senderWebsite  String?
  senderLinkedin String?

  // Campaign Settings
  approvalMode ApprovalMode @default(manual)
  aiEnabled    Boolean      @default(true)

  // Targeting
  targetIcp       String?  @db.Text // ICP description
  targetIndustry  String?
  targetCompanySize String?
  targetJobTitles  String[] @default([])

  // Email Settings
  dailySendLimit Int @default(50)
  sendWindow     Json? @db.Json // {startHour: 9, endHour: 17, timezone: "America/New_York"}

  // Timing
  startDate DateTime?
  endDate   DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  // Relations
  workspace     Project                @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  conversations OutreachConversation[]
  auditLogs     OutreachAuditLog[]

  @@index(workspaceId)
  @@index(status)
}

// -----------------------------------------------------------------------------
// OUTREACH CONVERSATION
// Tracks the full conversation thread with a single prospect
// -----------------------------------------------------------------------------

model OutreachConversation {
  id         String  @id @default(cuid())
  campaignId String
  prospectId String? // Link to PersonProfile if exists

  // Prospect Info
  prospectEmail      String
  prospectName       String?
  prospectTitle      String?
  prospectCompany    String?
  prospectLinkedin   String?
  prospectPhone      String?

  // Personalization
  icebreaker     String? @db.Text // AI-suggested personalized hook
  painPoint      String? @db.Text // Identified pain point
  valueProposition String? @db.Text // Customized value prop

  // Status & Flow
  status    ConversationStatus @default(pending_outreach)
  handledBy String             @default("ai") // ai, human, hybrid

  // Follow-up Tracking
  initialSentAt    DateTime?
  followUp1SentAt  DateTime?
  followUp2SentAt  DateTime?
  followUpFinalAt  DateTime?
  lastReplyAt      DateTime?
  nextActionAt     DateTime? // When to send next follow-up

  // Outcome
  meetingBookedAt DateTime?
  meetingUrl      String?

  // Metadata
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  closedAt  DateTime?

  // Relations
  campaign OutreachCampaign  @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  prospect PersonProfile?    @relation(fields: [prospectId], references: [id])
  messages OutreachMessage[]

  @@unique([campaignId, prospectEmail])
  @@index(campaignId)
  @@index(prospectId)
  @@index(status)
  @@index(nextActionAt)
}

// -----------------------------------------------------------------------------
// OUTREACH MESSAGE
// Individual messages in a conversation
// -----------------------------------------------------------------------------

model OutreachMessage {
  id             String @id @default(cuid())
  conversationId String

  // Message Content
  sender      MessageSender
  subject     String? // For initial emails
  content     String        @db.Text
  contentHtml String?       @db.Text

  // Generation Metadata
  generatedBy  MessageGeneratedBy?
  templateType EmailTemplateType?
  templateId   String? // Reference to EmailTemplate
  aiModel      String? // e.g., "claude-sonnet-4"
  aiPrompt     String?             @db.Text
  aiTokens     Int?
  aiCost       Decimal?            @db.Decimal(10, 4)

  // Email Tracking
  emailProviderId String? // Resend/SendGrid message ID
  sentAt          DateTime?
  deliveredAt     DateTime?
  openedAt        DateTime?
  clickedAt       DateTime?
  bouncedAt       DateTime?
  repliedAt       DateTime?

  // Approval (for manual mode)
  requiresApproval Boolean   @default(false)
  approvedBy       String? // User ID
  approvedAt       DateTime?
  rejectedAt       DateTime?
  rejectionReason  String?   @db.Text

  createdAt DateTime @default(now())

  // Relations
  conversation OutreachConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  template     EmailTemplate?       @relation(fields: [templateId], references: [id])

  @@index(conversationId)
  @@index(sentAt)
  @@index([requiresApproval, approvedAt])
}

// -----------------------------------------------------------------------------
// EMAIL TEMPLATE
// Reusable templates with variable placeholders
// -----------------------------------------------------------------------------

model EmailTemplate {
  id          String  @id @default(cuid())
  workspaceId String? // null = system template

  name        String
  type        EmailTemplateType
  description String?           @db.Text

  // Template Content
  subject  String
  body     String  @db.Text
  bodyHtml String? @db.Text

  // Variables available in this template
  variables String[] @default([])

  // Metadata
  isSystem Boolean @default(false)
  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  workspace Project?          @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  messages  OutreachMessage[]

  @@unique([workspaceId, type, name])
  @@index(workspaceId)
  @@index(type)
}

// -----------------------------------------------------------------------------
// OUTREACH AUDIT LOG
// Immutable log of all actions (CRITICAL for debugging & compliance)
// -----------------------------------------------------------------------------

model OutreachAuditLog {
  id             String  @id @default(cuid())
  campaignId     String?
  conversationId String?
  userId         String?

  action     String // email_queued, email_sent, reply_received, etc.
  entityType String? // campaign, conversation, message
  entityId   String?

  // Context
  metadata  Json?   @db.Json
  ipAddress String?
  userAgent String? @db.Text

  // AI-specific
  aiModel    String?
  aiPrompt   String?  @db.Text
  aiResponse String?  @db.Text
  aiTokens   Int?
  aiCost     Decimal? @db.Decimal(10, 4)

  createdAt DateTime @default(now())

  // Relations
  campaign OutreachCampaign? @relation(fields: [campaignId], references: [id])

  @@index(campaignId)
  @@index(conversationId)
  @@index(action)
  @@index(createdAt)
}
